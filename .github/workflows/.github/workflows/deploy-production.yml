name: DeployProduction

on:
  push:
    branches:
      - production

jobs:

  test:
    name: Unit + Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run all tests
        env:
          DOCKER_BUILDKIT: '1'
        run: make run_tests

  flake8:
    needs: test
    name: Style code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run flake8
        env:
          DOCKER_BUILDKIT: '1'
        run: pip install -U pip; pip install flake8; flake8 --count .

  deploy:
    needs: flake8
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to production server
      uses: appleboy/ssh-action@master
      env:
        USERNAME: ${{ secrets.DEPLOY_USER }}
        HOST: ${{ secrets.DEPLOY_ADDR_PROD }}
        SCRIPT: |
          cd /srv/rmi/${{ secrets.CI_PROJECT_NAME }}
          git fetch
          git checkout .
          git pull origin production
          {
            echo 'EMAIL_HOST=${{ secrets.EMAIL_HOST_PROD }}'
            echo 'EMAIL_PORT=${{ secrets.EMAIL_PORT_PROD }}'
            echo 'EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER_PROD }}'
            echo 'EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD_PROD }}'
            echo 'SENDER_ID=${{ secrets.SENDER_ID }}'
            echo 'SENDER_PASSWORD=${{ secrets.SENDER_PASSWORD }}'
            echo 'COMPANY_ID=${{ secrets.COMPANY_ID }}'
            echo 'USER_ID=${{ secrets.USER_ID }}'
            echo 'USER_PASSWORD=${{ secrets.USER_PASSWORD }}'
            echo 'GMAPS_API_KEY=${{ secrets.GMAPS_API_KEY }}'
            echo 'AZURE_ACCOUNT_NAME_PROD=${{ secrets.AZURE_ACCOUNT_NAME_PROD }}'
            echo 'AZURE_ACCOUNT_KEY_PROD=${{ secrets.AZURE_ACCOUNT_KEY_PROD }}'
            echo 'SIGN_UP_ACCESS_KEY=${{ secrets.SIGN_UP_ACCESS_KEY }}'
            echo 'AZURE_POSTGRES_USER=${{ secrets.AZURE_POSTGRES_USER_PROD }}'
            echo 'AZURE_POSTGRES_PASSWORD=${{ secrets.AZURE_POSTGRES_PASSWORD_PROD }}'
            echo 'AZURE_POSTGRES_HOST=${{ secrets.AZURE_POSTGRES_HOST_PROD }}'
            echo 'AZURE_POSTGRES_PORT=${{ secrets.AZURE_POSTGRES_PORT_PROD }}'
            echo 'AZURE_POSTGRES_DB=${{ secrets.AZURE_POSTGRES_DB_PROD }}'
            echo 'POWER_BI_TENANT_ID=${{ secrets.POWER_BI_TENANT_ID_PROD }}'
            echo 'POWER_BI_CLIENT_ID=${{ secrets.POWER_BI_CLIENT_ID_PROD}}'
            echo 'POWER_BI_CLIENT_SECRET=${{ secrets.POWER_BI_CLIENT_SECRET_PROD }}'
          } > docker_env.env
          make docker_prod_stop
          make docker_prod
          docker image prune -a --filter "until=24h" -f
          docker container prune --filter "until=24h" -f
        KEY: ${{ secrets.DEPLOY_KEY_PROD }}
